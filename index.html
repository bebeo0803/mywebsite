<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>B·∫£ng ƒêi·ªÅu Khi·ªÉn</title>
    <!-- 1) Include Paho JavaScript (b·∫°n ƒë√£ t·∫£i v·ªÅ tr∆∞·ªõc ƒë√≥, ƒë·∫∑t t√™n file l√† paho-mqtt.js) -->
  <script src="paho-mqtt.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #2c2c2c;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px 0;
      min-height: 100vh;
      margin: 0;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(2, 160px);
      gap: 16px;
    }

    .widget {
      background: #444;
      border-radius: 16px;
      padding: 14px;
      text-align: center;
      transition: background 0.3s, color 0.3s;
    }

    .widget .icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    .light {
      cursor: pointer;
    }

    .light.on {
      background: #f5e342;
      color: #000;
    }

    svg {
      transform: rotate(-90deg);
    }

    .needle {
      stroke: #ff4757;
      stroke-width: 3;
      transform-origin: center;
      transition: transform 0.4s ease-out;
    }

    .label {
      margin-top: 8px;
      font-weight: bold;
    }

    .value {
      font-size: 18px;
    }
  </style>
</head>
<body>
  <div class="grid">

    <!-- ƒê√®n -->
    <div class="widget light" onclick="toggleLight(this)">
      <div class="icon">üí°</div>
      <div>ƒê√®n 1</div>
      <div> </div>
    </div>
    <div class="widget light" onclick="toggleLight(this)">
      <div class="icon">üí°</div>
      <div>ƒê√®n 2</div>
      <div> </div>
    </div>
    <div class="widget light" onclick="toggleLight(this)">
      <div class="icon">üí°</div>
      <div>ƒê√®n 3</div>
      <div> </div>
    </div>
    <div class="widget light" onclick="toggleLight(this)">
      <div class="icon">üí°</div>
      <div>ƒê√®n 4</div>
      <div> </div>
    </div>

    <!-- Nhi·ªát ƒë·ªô (gauge) -->
    <div class="widget">
      <svg width="120" height="120">
        <circle cx="60" cy="60" r="50" stroke="#888" stroke-width="10" fill="none"/>
        <line x1="60" y1="60" x2="60" y2="20" class="needle" id="tempNeedle"/>
      </svg>
      <div class="label">Nhi·ªát ƒë·ªô</div>
      <div class="value" id="tempValue">-- ¬∞C</div>
    </div>

    <!-- ƒê·ªô ·∫©m (gauge) -->
    <div class="widget">
      <svg width="120" height="120">
        <circle cx="60" cy="60" r="50" stroke="#888" stroke-width="10" fill="none"/>
        <line x1="60" y1="60" x2="60" y2="20" class="needle" id="humidNeedle"/>
      </svg>
      <div class="label">ƒê·ªô ·∫©m</div>
      <div class="value" id="humidValue">-- %</div>
    </div>

    <!-- ƒêi·ªán √°p -->
    <div class="widget">
      <div class="icon">üîã</div>
      <div>ƒêi·ªán √°p: <span id="voltValue">220</span> V</div>
      <div>3 gi·ªù tr∆∞·ªõc</div>
    </div>

    <!-- D√≤ng ƒëi·ªán -->
    <div class="widget">
      <div class="icon">‚ö°</div>
      <div>D√≤ng ƒëi·ªán: <span id="currValue">1.5</span> A</div>
      <div>3 gi·ªù tr∆∞·ªõc</div>
    </div>
  </div>
    <!-- <div id="status">Tr·∫°ng th√°i: <span id="connStatus">Ch∆∞a k·∫øt n·ªëi</span></div>

    <h3>Log (Nh·∫≠t k√Ω)</h3>
    <div id="log" style="color: white; background: black; overflow-y: auto; height: 200px;"></div> -->
  <script>

    // ==== 1. C·∫§U H√åNH TH√îNG TIN K·∫æT N·ªêI ====
    const host = "c0bd0fdb7b5c40ed9db880066910a4b8.s1.eu.hivemq.cloud";   // V√≠ d·ª•: abcdefg12345.s1.eu.hivemq.cloud
    const port = 8884;                      // c·ªïng wss:// (MQTT over TLS WebSocket)
    const clientId = "webClient-" + Math.floor(Math.random() * 10000);
    const username = "giangduc";             // Thay b·∫±ng user HiveMQ Cloud
    const password = "12345678Giang";         // Thay b·∫±ng password t∆∞∆°ng ·ª©ng

    let client = null;

    // ==== 2. KH·ªûI T·∫†O ƒê·ªêI T∆Ø·ª¢NG MQTT ==== 
    function initMQTT() {
      // DEBUG: ki·ªÉm tra xem Paho v√† Paho.Client ƒë√£ t·ªìn t·∫°i ch∆∞a
      console.log("Paho:", Paho);
      console.log("Paho.Client:", Paho && Paho.Client);

      if (!Paho || typeof Paho.Client !== "function") {
        console.error("Paho.Client ch∆∞a load ƒë∆∞·ª£c. Vui l√≤ng ki·ªÉm tra l·∫°i <script> include.");
        // document.getElementById("connStatus").innerText = "L·ªói th∆∞ vi·ªán";
        // document.getElementById("connStatus").style.color = "red";
        return;
      }

      // Path m·∫∑c ƒë·ªãnh HiveMQ Cloud th∆∞·ªùng ƒë·ªÉ "/mqtt"
      const path = "/mqtt";
      client = new Paho.Client(host, Number(port), path, clientId);

      client.onConnectionLost = onConnectionLost;
      client.onMessageArrived = onMessageArrived;

      const options = {
        useSSL: true,
        userName: username,
        password: password,
        onSuccess: onConnect,
        onFailure: onFailure
      };

      client.connect(options);
      console.log("ƒêang k·∫øt n·ªëi t·ªõi " + host + ":" + port + path + " ...");
    }

    // ==== 3. CALLBACK KHI K·∫æT N·ªêI TH√ÄNH C√îNG ====
    function onConnect() {
      console.log("=== ƒê√£ k·∫øt n·ªëi th√†nh c√¥ng ƒë·∫øn HiveMQ Cloud ===");
      // document.getElementById("connStatus").innerText = "ƒê√£ k·∫øt n·ªëi";
      // document.getElementById("connStatus").style.color = "green";
      // (T√πy ch·ªçn) Subscribe m·ªôt topic m·∫∑c ƒë·ªãnh
      client.subscribe("home/data");
      // log("ƒê√£ g·ª≠i l·ªánh SUBSCRIBE t·ªõi 'home/data'");
    }

    // ==== 4. CALLBACK KHI K·∫æT N·ªêI TH·∫§T B·∫†I ====
    function onFailure(response) {
      console.log("### K·∫øt n·ªëi th·∫•t b·∫°i: " + response.errorMessage);
      // document.getElementById("connStatus").innerText = "Th·∫•t b·∫°i";
      // document.getElementById("connStatus").style.color = "red";
    }

    // ==== 5. CALLBACK KHI M·∫§T K·∫æT N·ªêI ====
    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        // log("### ƒê√£ m·∫•t k·∫øt n·ªëi: " + responseObject.errorMessage);
        document.getElementById("connStatus").innerText = "Ng·∫Øt k·∫øt n·ªëi";
        document.getElementById("connStatus").style.color = "orange";
        // T·ª± ƒë·ªông c·ªë g·∫Øng reconnect sau 3 gi√¢y
        setTimeout(initMQTT, 3000);
      }
    }

  isFistConnect = true; // Bi·∫øn ƒë·ªÉ ki·ªÉm tra l·∫ßn k·∫øt n·ªëi ƒë·∫ßu ti√™n
    // ==== 6. CALLBACK KHI C√ì TIN NH·∫ÆN ƒê·∫æN ====
  function onMessageArrived(message) {
    const topic = message.destinationName;
    const payload = message.payloadString;
    // log(`[Tin ƒë·∫øn] Topic="${topic}", N·ªôi dung="${payload}"`);

    let data;
    try {
      data = JSON.parse(payload);
    } catch (err) {
      console.error("Kh√¥ng parse ƒë∆∞·ª£c JSON:", err);
      return;
    }

    // 1) C·∫≠p nh·∫≠t gauge Nhi·ªát ƒë·ªô (max 50¬∞C)
    setGauge("tempNeedle", data.temperature, 50, "tempValue", "¬∞C");

    // 2) C·∫≠p nh·∫≠t gauge ƒê·ªô ·∫©m (max 100%)
    setGauge("humidNeedle", data.humidity, 100, "humidValue", "%");

    // 3) C·∫≠p nh·∫≠t ƒêi·ªán √°p v√† D√≤ng ƒëi·ªán
    document.getElementById("voltValue").textContent = data.volt;
    document.getElementById("currValue").textContent = data.current;

    // 4) C·∫≠p nh·∫≠t tr·∫°ng th√°i c√°c ƒê√®n
    // Gi·∫£ s·ª≠ b·∫°n c√≥ ƒë√∫ng 4 ph·∫ßn t·ª≠ .widget.light theo th·ª© t·ª± ƒê√®n 1‚Üí4
    if (isFistConnect) {
      const lights = document.querySelectorAll('.widget.light');
      lights.forEach((el, idx) => {
        // L·∫•y key t∆∞∆°ng ·ª©ng trong JSON: light_1_state, light_2_state, ‚Ä¶
        const key = `light_${idx + 1}_state`;
        const state = data[key];
        if (state === 1) {
          el.classList.add('on');
        } else {
          el.classList.remove('on');
        }
      });
   
      isFistConnect = false; // Ch·ªâ subscribe m·ªôt l·∫ßn
    }
  }

    // ==== 7. H√ÄM GHI LOG RA KHUNG HTML ====
    function log(txt) {
      const logDiv = document.getElementById("log");
      const now = new Date().toLocaleTimeString();
      logDiv.innerHTML += `[${now}] ${txt}<br/>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // ==== 8. SUBSCRIBE TOPIC ====
    function subscribeTopic(topic) {
    if (!client) {
      alert("Client ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o!");
      return;
    }
    if (client.connected === false) {
      alert("Client ch∆∞a k·∫øt n·ªëi th√†nh c√¥ng!");
      return;
    }
    client.subscribe(topic);
    // log(`ƒê√£ g·ª≠i l·ªánh SUBSCRIBE t·ªõi "${topic}"`);
  }

    // ==== 9. UNSUBSCRIBE TOPIC ====
    function unsubscribeTopic() {
      const topic = document.getElementById("topicInput").value.trim();
      if (!topic) {
        alert("Vui l√≤ng nh·∫≠p topic ƒë·ªÉ unsubscribe!");
        return;
      }
      client.unsubscribe(topic);
      // log(`ƒê√£ g·ª≠i l·ªánh UNSUBSCRIBE t·ªõi "${topic}"`);
    }

    // ==== 10. PUBLISH TIN NH·∫ÆN ====
    function publishTopic(topic, msg) {
      if (!client) {
        alert("Client ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o!");
        return;
      }
 
      if (!topic || !msg) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß topic v√† n·ªôi dung tin nh·∫Øn!");
        return;
      }
      // Ch√∫ √Ω: gi·ªù d√πng Paho.Message, kh√¥ng ph·∫£i Paho.MQTT.Message
      const message = new Paho.Message(msg);
      message.destinationName = topic;
      message.qos = 0;
      message.retained = false;
      client.send(message);
      // log(`ƒê√£ g·ª≠i PUBLISH t·ªõi "${topic}": ${msg}`);
      document.getElementById("messageInput").value = "";
    }
 
    // ==== 11. G√ÅN S·ª∞ KI·ªÜN CHO C√ÅC N√öT ====
      window.addEventListener("load", () => {
      // document.getElementById("subscribeBtn").addEventListener("click", subscribeTopic);
      // document.getElementById("unsubscribeBtn").addEventListener("click", unsubscribeTopic);
      // document.getElementById("publishBtn").addEventListener("click", publishTopic);
      initMQTT();
    });
 
    function toggleLight(el) {
      el.classList.toggle('on');
      const nameDiv = el.children[1];      
      const lightName = nameDiv.textContent.trim(); 
      if (isLightOn(el)) {
        publishTopic("home/lights", lightName + " ON");
        // log(`ƒê√®n "${el.textContent.trim()}" ƒë√£ b·∫≠t`);
      } else {
        publishTopic("home/lights", lightName + " OFF");
        // log(`ƒê√®n "${el.textContent.trim()}" ƒë√£ t·∫Øt`);
      }
    }
    function isLightOn(el) {
      return el.classList.contains('on');
    }
    function setGauge(needleId, value, maxValue, valueDisplayId, unit) {
      const angle = (value / maxValue) * 180;
      const needle = document.getElementById(needleId);
      needle.style.transform = `rotate(${angle}deg)`;

      const display = document.getElementById(valueDisplayId);
      display.textContent = `${value} ${unit}`;
    }

    // Gi√° tr·ªã m·∫´u
    const temp = 100;   // ¬∞C
    const humid = 65;  // %

    setGauge("tempNeedle", temp, 50, "tempValue", "¬∞C");
    setGauge("humidNeedle", humid, 100, "humidValue", "%");
  </script>
</body>
</html>
